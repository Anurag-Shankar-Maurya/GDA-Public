{% extends "content_base.html" %}
{% load i18n %}
{% load content_filters %}

{% block title %}{% trans "GDA Project" %}: {{ project.title }}{% endblock %}
{% block social_meta %}
<meta name="description" content="{{ project.teaser|default:project.background_objectives|striptags|truncatechars:160|escape }}">
<meta property="og:title" content="{{ project.title|escape }}">
<meta property="og:description" content="{{ project.teaser|default:project.background_objectives|striptags|truncatechars:200|escape }}">
<meta property="og:image" content="{% if project.cover_image_blob %}{% url 'content_serve_blob' 'project' project.pk 'cover_image_blob' %}{% elif project.cover_image %}{{ project.cover_image.url }}{% elif project.cover_image_url %}{{ project.cover_image_url }}{% else %}{% static 'images/logo.png' %}{% endif %}">
<meta name="twitter:title" content="{{ project.title|escape }}">
<meta name="twitter:description" content="{{ project.teaser|default:project.background_objectives|striptags|truncatechars:200|escape }}">
<meta name="twitter:image" content="{% if project.cover_image_blob %}{% url 'content_serve_blob' 'project' project.pk 'cover_image_blob' %}{% elif project.cover_image %}{{ project.cover_image.url }}{% elif project.cover_image_url %}{{ project.cover_image_url }}{% else %}{% static 'images/logo.png' %}{% endif %}">
{% endblock %}

{% block canonical %}
    <link rel="canonical" href="{% if request %}{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.get_host }}{% url 'content_project_detail' project.pk %}{% endif %}">
{% endblock %}

{% block breadcrumb %}
    <li class="flex items-center">
        <a href="{% url 'landing_page' %}" class="text-primary-blue dark:text-accent-light hover:text-accent-blue dark:hover:text-text-dark transition-colors duration-200">{% trans "Home" %}</a>
        <i class="fas fa-chevron-right h-3 w-3 text-text-light-secondary dark:text-text-dark-secondary mx-2"></i>
    </li>
    <li class="flex items-center">
        <a href="{% url 'content_project_list' %}" class="text-primary-blue dark:text-accent-light hover:text-accent-blue dark:hover:text-text-dark transition-colors duration-200">{% trans "Projects" %}</a>
        <i class="fas fa-chevron-right h-3 w-3 text-text-light-secondary dark:text-text-dark-secondary mx-2"></i>
    </li>
    <li class="flex items-center">
        <a href="{% url 'content_project_detail' project.pk %}" class="text-primary-blue dark:text-accent-light hover:text-accent-blue dark:hover:text-text-dark transition-colors duration-200">{{ project.title }}</a>
    </li>
{% endblock %}

{% block content %}
    <style>
        /* Smooth scrolling for anchor links on this page */
        html { scroll-behavior: smooth; }

        /* Simple line-clamp helpers for 1-3 lines */
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        /* Ensure anchor scrolls into view below fixed header */
        #background, #apply { scroll-margin-top: 120px; }
    </style>

    {# HERO / BANNER - Landing-like UI for project #}
    <section class="relative w-full h-[70vh] lg:h-[75vh] overflow-hidden mb-8 bg-light-secondary-bg dark:bg-dark-secondary-bg rounded-b-3xl shadow-md border-b border-border-light dark:border-border-dark">
        {% if project.cover_image_blob or project.cover_image or project.cover_image_url %}
        <div class="absolute inset-0">
            {% if project.cover_image_blob %}
                <img src="{% url 'content_serve_blob' 'project' project.pk 'cover_image_blob' %}" alt="{{ project.title }} cover" class="w-full h-full object-cover">
            {% elif project.cover_image %}
                <img src="{{ project.cover_image.url }}" alt="{{ project.title }} cover" class="w-full h-full object-cover">
            {% elif project.cover_image_url %}
                <img src="{{ project.cover_image_url }}" alt="{{ project.title }} cover" class="w-full h-full object-cover">
            {% endif %}
        </div>
        {% endif %}

        <!-- Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-r from-primary-dark/90 via-primary-dark/60 to-transparent z-10"></div>
        
        <div class="relative z-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center">
            <div class="w-full lg:w-2/3 text-left text-text-dark">
                <div class="flex flex-wrap items-center gap-3 mb-6">
                    <a href="{% url 'content_project_list' %}" class="inline-flex items-center px-3 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg text-sm font-medium transition-colors border border-white/10">
                        <i class="fas fa-arrow-left mr-2"></i> {% trans "Back" %}
                    </a>
                    {% if project.is_hero_highlight %}
                        <span class="px-3 py-1.5 bg-warning text-primary-dark rounded-full text-xs font-bold flex items-center gap-2 shadow-sm">
                            <i class="fas fa-star"></i> {% trans "Hero Highlight" %}
                        </span>
                    {% endif %}
                    {% if project.is_featured %}
                        <span class="px-3 py-1.5 bg-error text-white rounded-full text-xs font-bold flex items-center gap-2 shadow-sm">
                            <i class="fas fa-heart"></i> {% trans "Featured" %}
                        </span>
                    {% endif %}
                </div>

                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold leading-tight mb-4 drop-shadow-lg text-text-dark">
                    {{ project.title }}
                </h1>

                {% if project.teaser %}
                    <p id="hero-teaser" class="text-lg md:text-xl mb-8 max-w-3xl text-text-dark line-clamp-2 leading-relaxed font-light">{{ project.teaser }}</p>
                {% endif %}

                <div class="flex flex-wrap items-center gap-4 mb-8">
                    <a href="#apply" class="inline-flex items-center px-8 py-3.5 bg-accent-blue hover:bg-accent-dark text-text-dark font-bold rounded-full shadow-lg shadow-accent-blue/30 transition-all duration-300 transform hover:-translate-y-1">
                        {% trans "Apply Now" %}
                    </a>
                    <a href="#background" class="inline-flex items-center px-6 py-3.5 bg-white/10 hover:bg-white/20 backdrop-blur-md text-text-dark border border-white/30 rounded-full font-semibold shadow-sm transition-all duration-300">
                        <i class="fas fa-info-circle mr-2"></i> {% trans "Learn More" %}
                    </a>
                </div>

                <div class="flex flex-wrap gap-4 items-center text-sm font-medium">
                    <div class="inline-flex items-center gap-2 bg-black/30 backdrop-blur-sm px-4 py-2 rounded-full border border-white/10">
                        <i class="fas fa-map-marker-alt text-accent-light"></i>
                        <span>{{ project.country|default:"—" }}</span>
                    </div>
                    <div class="inline-flex items-center gap-2 bg-black/30 backdrop-blur-sm px-4 py-2 rounded-full border border-white/10">
                        <i class="fas fa-clock text-accent-light"></i>
                        <span>{{ project.duration|default:"—" }}h</span>
                    </div>
                    <div class="inline-flex items-center gap-2 bg-black/30 backdrop-blur-sm px-4 py-2 rounded-full border border-white/10">
                        <i class="fas fa-users text-accent-light"></i>
                        <span>{{ project.headcount|default:0 }}/{{ project.total_headcount|default:0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Quick Access Feature Grid (compact) -->
        <div class="mb-10 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <div class="p-5 rounded-2xl bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-primary-blue/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-map-marker-alt text-primary-blue text-lg"></i>
                </div>
                <div>
                    <div class="text-xs font-bold uppercase tracking-wide text-text-light-secondary dark:text-text-dark-secondary mb-0.5">{% trans "Location" %}</div>
                    <div class="font-bold text-text-light dark:text-text-dark">{{ project.country|default:"—" }}</div>
                </div>
            </div>
            <div class="p-5 rounded-2xl bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-tag text-success text-lg"></i>
                </div>
                <div>
                    <div class="text-xs font-bold uppercase tracking-wide text-text-light-secondary dark:text-text-dark-secondary mb-0.5">{% trans "Theme" %}</div>
                    <div class="font-bold text-text-light dark:text-text-dark">{{ project.theme|default:"—" }}</div>
                </div>
            </div>
            <div class="p-5 rounded-2xl bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-accent-blue/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-clock text-accent-blue text-lg"></i>
                </div>
                <div>
                    <div class="text-xs font-bold uppercase tracking-wide text-text-light-secondary dark:text-text-dark-secondary mb-0.5">{% trans "Duration" %}</div>
                    <div class="font-bold text-text-light dark:text-text-dark">{{ project.duration|default:"—" }}h</div>
                </div>
            </div>
            <div class="p-5 rounded-2xl bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-users text-warning text-lg"></i>
                </div>
                <div>
                    <div class="text-xs font-bold uppercase tracking-wide text-text-light-secondary dark:text-text-dark-secondary mb-0.5">{% trans "Volunteers" %}</div>
                    <div class="font-bold text-text-light dark:text-text-dark">{{ project.headcount|default:0 }}/{{ project.total_headcount|default:0 }}</div>
                </div>
            </div>
        </div>

        <div class="mb-8 flex items-center justify-between border-b border-border-light dark:border-border-dark pb-4">
             <div class="flex items-center gap-4 text-sm text-text-light-secondary dark:text-text-dark-secondary">
                <div class="inline-flex items-center gap-2">
                    <i class="fas fa-user-friends text-accent-blue"></i>
                    <span>{% trans "Trusted by" %} <strong class="text-primary-blue dark:text-text-dark">2,000+</strong> {% trans "volunteers" %}</span>
                </div>
            </div>
            <div class="inline-flex items-center gap-2">
                <button class="text-accent-blue hover:text-accent-dark transition-colors font-medium text-sm flex items-center gap-1">
                    <i class="fas fa-share-alt"></i> <span>{% trans "Share" %}</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
                    
                    {# Back button #}
                    <div class="p-6 pb-0">
                        <a href="{% url 'content_project_list' %}" class="inline-flex items-center px-4 py-2 border border-border-light dark:border-border-dark text-sm font-medium rounded-lg text-text-light-secondary dark:text-text-dark-secondary bg-light-secondary-bg dark:bg-dark-bg hover:bg-white dark:hover:bg-gray-700 hover:text-primary-blue dark:hover:text-white transition-all duration-300 shadow-sm">
                            <i class="fas fa-arrow-left mr-2"></i>
                            {% trans "Back to Projects" %}
                        </a>
                    </div>

                    <!-- Project Header -->
                    <div class="p-8">
                        <div class="flex flex-wrap gap-2 mb-6">
                            {% if project.is_active %}
                                <span class="px-3 py-1 bg-success/10 text-success text-xs font-bold rounded-full border border-success/20">
                                    <i class="fas fa-check-circle mr-1"></i>{% trans "Active" %}
                                </span>
                            {% else %}
                                <span class="px-3 py-1 bg-error/10 text-error text-xs font-bold rounded-full border border-error/20">
                                    <i class="fas fa-times-circle mr-1"></i>{% trans "Inactive" %}
                                </span>
                            {% endif %}
                            {% if project.is_hero_highlight %}
                                <span class="px-3 py-1 bg-warning/10 text-warning text-xs font-bold rounded-full border border-warning/20">
                                    <i class="fas fa-star mr-1"></i>{% trans "Hero Highlight" %}
                                </span>
                            {% endif %}
                            {% if project.is_featured %}
                                <span class="px-3 py-1 bg-error/10 text-error text-xs font-bold rounded-full border border-error/20">
                                    <i class="fas fa-heart mr-1"></i>{% trans "Featured" %}
                                </span>
                            {% endif %}
                            {% if project.is_full %}
                                <span class="px-3 py-1 bg-warning/10 text-warning text-xs font-bold rounded-full border border-warning/20">
                                    <i class="fas fa-users mr-1"></i>{% trans "Full" %}
                                </span>
                            {% endif %}
                        </div>
                        
                        <h1 class="text-3xl md:text-4xl font-extrabold text-primary-blue dark:text-text-dark mb-4 leading-tight">
                            {{ project.title }}
                        </h1>
                        
                        <!-- Quick Info Grid (Detailed) -->
                        <div class="grid grid-cols-2 gap-4 mb-8">
                            <div class="bg-light-secondary-bg dark:bg-dark-bg rounded-xl p-4 border border-border-light dark:border-border-dark">
                                <div class="text-xs text-text-light-secondary dark:text-text-dark-secondary uppercase tracking-wide mb-1 font-bold">
                                    <i class="fas fa-map-marker-alt mr-1 text-primary-blue"></i>{% trans "Location" %}
                                </div>
                                <div class="text-base font-bold text-text-light dark:text-text-dark">{{ project.country|default:"N/A" }}</div>
                            </div>
                            <div class="bg-light-secondary-bg dark:bg-dark-bg rounded-xl p-4 border border-border-light dark:border-border-dark">
                                <div class="text-xs text-text-light-secondary dark:text-text-dark-secondary uppercase tracking-wide mb-1 font-bold">
                                    <i class="fas fa-tag mr-1 text-success"></i>{% trans "Theme" %}
                                </div>
                                <div class="text-base font-bold text-text-light dark:text-text-dark">{{ project.theme|default:"N/A" }}</div>
                            </div>
                            <div class="bg-light-secondary-bg dark:bg-dark-bg rounded-xl p-4 border border-border-light dark:border-border-dark">
                                <div class="text-xs text-text-light-secondary dark:text-text-dark-secondary uppercase tracking-wide mb-1 font-bold">
                                    <i class="fas fa-clock mr-1 text-accent-blue"></i>{% trans "Duration" %}
                                </div>
                                <div class="text-base font-bold text-text-light dark:text-text-dark">{{ project.duration|default:"N/A" }}h</div>
                            </div>
                            <div class="bg-light-secondary-bg dark:bg-dark-bg rounded-xl p-4 border border-border-light dark:border-border-dark">
                                <div class="text-xs text-text-light-secondary dark:text-text-dark-secondary uppercase tracking-wide mb-1 font-bold">
                                    <i class="fas fa-users mr-1 text-warning"></i>{% trans "Volunteers" %}
                                </div>
                                <div class="text-base font-bold text-text-light dark:text-text-dark">{{ project.headcount|default:0 }}/{{ project.total_headcount|default:0 }}</div>
                            </div>
                        </div>

                        {% if project.difficulty %}
                        <div class="mb-8">
                            <span class="inline-flex items-center px-4 py-2 bg-primary-blue/5 dark:bg-primary-blue/20 text-primary-blue dark:text-primary-light rounded-full text-sm font-semibold border border-primary-blue/10">
                                <i class="fas fa-chart-line mr-2"></i>
                                {% trans "Difficulty:" %} {{ project.get_difficulty_display }}
                            </span>
                        </div>
                        {% endif %}

                        <!-- Teaser -->
                        {% if project.teaser %}
                        <div class="mb-10 p-6 bg-gradient-to-br from-primary-blue/5 to-accent-blue/5 dark:from-primary-blue/20 dark:to-accent-blue/10 rounded-xl border-l-4 border-accent-blue">
                            <div id="content-container-teaser" class="prose dark:prose-invert max-w-none text-text-light dark:text-text-dark line-clamp-3">
                                <p class="text-lg font-medium italic leading-relaxed">{{ project.teaser }}</p>
                            </div>
                            <button id="read-more-btn-teaser" class="mt-4 text-sm font-bold text-accent-blue hover:text-accent-dark hidden uppercase tracking-wider" data-more="{% trans 'Read More' %}" data-less="{% trans 'Read Less' %}">{% trans 'Read More' %} <i class="fas fa-chevron-down ml-1"></i></button>
                        </div>
                        {% endif %}

                        <!-- Background & Objectives -->
                        <div id="background" class="mb-10 group">
                            <h3 class="text-2xl font-bold text-primary-blue dark:text-text-dark mb-4 flex items-center pb-2 border-b border-border-light dark:border-border-dark group-hover:border-accent-blue transition-colors">
                                <i class="fas fa-bullseye text-accent-blue mr-3 p-2 bg-accent-blue/10 rounded-lg"></i>
                                {% trans "Background & Objectives" %}
                            </h3>
                            <div class="prose dark:prose-invert max-w-none text-text-light dark:text-text-dark-secondary leading-relaxed" id="content-container-bg">
                                {{ project.background_objectives|linebreaks }}
                            </div>
                            <button id="read-more-btn-bg" class="mt-4 px-4 py-2 bg-light-secondary-bg dark:bg-dark-bg text-text-light dark:text-text-dark text-sm font-semibold rounded-lg hover:bg-border-light dark:hover:bg-border-dark transition-colors hidden" data-more="{% trans 'Read More' %}" data-less="{% trans 'Read Less' %}">{% trans 'Read More' %}</button>
                        </div>

                        <!-- Tasks & Eligibility -->
                        <div class="mb-10 group">
                            <h3 class="text-2xl font-bold text-primary-blue dark:text-text-dark mb-4 flex items-center pb-2 border-b border-border-light dark:border-border-dark group-hover:border-success transition-colors">
                                <i class="fas fa-tasks text-success mr-3 p-2 bg-success/10 rounded-lg"></i>
                                {% trans "Tasks & Eligibility" %}
                            </h3>
                            <div class="prose dark:prose-invert max-w-none text-text-light dark:text-text-dark-secondary leading-relaxed" id="content-container-tasks">
                                {{ project.tasks_eligibility|linebreaks }}
                            </div>
                            <button id="read-more-btn-tasks" class="mt-4 px-4 py-2 bg-light-secondary-bg dark:bg-dark-bg text-text-light dark:text-text-dark text-sm font-semibold rounded-lg hover:bg-border-light dark:hover:bg-border-dark transition-colors hidden" data-more="{% trans 'Read More' %}" data-less="{% trans 'Read Less' %}">{% trans 'Read More' %}</button>
                        </div>

                        <!-- Project Roadmap (Simple Timeline) -->
                        <div class="mb-10">
                            <h3 class="text-2xl font-bold text-primary-blue dark:text-text-dark mb-6 flex items-center">
                                <i class="fas fa-route text-warning mr-3 p-2 bg-warning/10 rounded-lg"></i>
                                {% trans "Project Roadmap" %}
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {% if project.application_deadline %}
                                <div class="relative p-5 rounded-xl bg-light-secondary-bg dark:bg-dark-bg border border-border-light dark:border-border-dark hover:border-warning/50 transition-colors">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-warning rounded-t-xl"></div>
                                    <div class="text-xs text-warning uppercase font-bold tracking-wider mb-2">{% trans "Apply By" %}</div>
                                    <div class="font-bold text-lg text-text-light dark:text-text-dark">{{ project.application_deadline|date:"M d, Y" }}</div>
                                    <div class="text-sm text-text-light-secondary dark:text-text-dark-secondary">{{ project.application_deadline|date:"H:i" }}</div>
                                </div>
                                {% endif %}

                                {% if project.start_date %}
                                <div class="relative p-5 rounded-xl bg-light-secondary-bg dark:bg-dark-bg border border-border-light dark:border-border-dark hover:border-success/50 transition-colors">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-success rounded-t-xl"></div>
                                    <div class="text-xs text-success uppercase font-bold tracking-wider mb-2">{% trans "Start" %}</div>
                                    <div class="font-bold text-lg text-text-light dark:text-text-dark">{{ project.start_date|date:"M d, Y" }}</div>
                                </div>
                                {% endif %}

                                {% if project.end_date %}
                                <div class="relative p-5 rounded-xl bg-light-secondary-bg dark:bg-dark-bg border border-border-light dark:border-border-dark hover:border-error/50 transition-colors">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-error rounded-t-xl"></div>
                                    <div class="text-xs text-error uppercase font-bold tracking-wider mb-2">{% trans "End" %}</div>
                                    <div class="font-bold text-lg text-text-light dark:text-text-dark">{{ project.end_date|date:"M d, Y" }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Application Section -->
                        <div id="apply"></div>
                        {% if user.is_authenticated and can_apply %}
                            <div class="bg-gradient-to-r from-success to-emerald-600 rounded-2xl p-8 text-white shadow-lg relative overflow-hidden">
                                <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                                <div class="relative z-10">
                                    <h3 class="text-2xl font-bold mb-3 flex items-center">
                                        <i class="fas fa-rocket mr-3"></i>
                                        {% trans "Ready to Make a Difference?" %}
                                    </h3>
                                    <p class="mb-6 opacity-90 text-lg">{% trans "Join this amazing project and contribute to meaningful change!" %}</p>
                                    <a href="{% url 'apply_to_project' project.pk %}" class="inline-flex items-center px-8 py-3.5 bg-white text-emerald-600 font-bold rounded-xl shadow-lg hover:shadow-xl hover:bg-gray-50 transition-all duration-300 transform hover:-translate-y-1">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        {% trans "Apply Now" %}
                                    </a>
                                </div>
                            </div>
                        {% elif user.is_authenticated and is_enrolled %}
                            <div class="bg-gradient-to-r from-accent-blue to-primary-light rounded-2xl p-8 text-white shadow-lg">
                                <div class="flex items-center">
                                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mr-6 shrink-0">
                                        <i class="fas fa-check text-3xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold mb-2">{% trans "You're Enrolled!" %}</h3>
                                        <p class="opacity-90">{% trans "You are currently enrolled in this project. Check your dashboard for updates." %}</p>
                                    </div>
                                </div>
                            </div>
                        {% elif not user.is_authenticated %}
                            <div class="bg-gradient-to-r from-text-light to-text-light-secondary dark:from-dark-secondary-bg dark:to-border-dark rounded-2xl p-8 text-white shadow-lg border border-border-light dark:border-border-dark">
                                <h3 class="text-xl font-bold mb-3 flex items-center">
                                    <i class="fas fa-sign-in-alt mr-2"></i>
                                    {% trans "Login Required" %}
                                </h3>
                                <p class="mb-6 opacity-90">{% trans "Please log in to apply for this project." %}</p>
                                <a href="{% url 'login' %}" class="inline-flex items-center px-6 py-3 bg-white text-text-light font-bold rounded-lg shadow-md hover:bg-gray-100 transition-all duration-300">
                                    <i class="fas fa-user mr-2"></i>
                                    {% trans "Log In" %}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Sticky Apply CTA (Landing-like) -->
                <div class="sticky top-24 z-30">
                    <div class="bg-white dark:bg-dark-secondary-bg rounded-2xl p-6 shadow-xl border border-border-light dark:border-border-dark ring-4 ring-light-secondary-bg dark:ring-dark-bg">
                        <h4 class="text-xl font-bold text-primary-blue dark:text-text-dark mb-2">{% trans "Ready to Join?" %}</h4>
                        <p class="text-sm text-text-light-secondary dark:text-text-dark-secondary mb-6">{% trans "Apply now to secure your spot in this project." %}</p>
                        {% if user.is_authenticated and can_apply %}
                            <a href="{% url 'apply_to_project' project.pk %}" class="block text-center w-full px-4 py-3 bg-accent-blue hover:bg-accent-dark text-white rounded-xl font-bold shadow-lg shadow-accent-blue/30 transition-all transform hover:-translate-y-0.5">{% trans "Apply Now" %}</a>
                        {% elif user.is_authenticated and is_enrolled %}
                            <div class="block text-center w-full px-4 py-3 bg-success/10 text-success border border-success/20 rounded-xl font-bold">{% trans "Enrolled" %}</div>
                        {% else %}
                            <a href="{% url 'login' %}?next={% url 'content_project_detail' project.pk %}" class="block text-center w-full px-4 py-3 bg-primary-blue hover:bg-primary-dark text-white rounded-xl font-bold shadow-md transition-all">{% trans "Log in to Apply" %}</a>
                        {% endif %}
                    </div>
                </div>

                <!-- Project Timeline -->
                <div class="bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-text-light dark:text-text-dark mb-4 flex items-center">
                        <i class="fas fa-calendar-alt text-accent-blue mr-2"></i>
                        {% trans "Timeline" %}
                    </h3>
                    <div class="space-y-4">
                        {% if project.application_deadline %}
                        <div class="flex gap-3">
                            <div class="flex flex-col items-center">
                                <div class="w-3 h-3 bg-warning rounded-full ring-4 ring-warning/10"></div>
                                <div class="w-0.5 h-full bg-border-light dark:border-border-dark my-1"></div>
                            </div>
                            <div class="pb-4">
                                <div class="text-xs text-warning uppercase font-bold tracking-wide mb-0.5">{% trans "Application Deadline" %}</div>
                                <div class="text-sm font-semibold text-text-light dark:text-text-dark">
                                    {{ project.application_deadline|date:"M d, Y H:i" }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if project.start_date %}
                        <div class="flex gap-3">
                            <div class="flex flex-col items-center">
                                <div class="w-3 h-3 bg-success rounded-full ring-4 ring-success/10"></div>
                                <div class="w-0.5 h-full bg-border-light dark:border-border-dark my-1"></div>
                            </div>
                            <div class="pb-4">
                                <div class="text-xs text-success uppercase font-bold tracking-wide mb-0.5">{% trans "Start Date" %}</div>
                                <div class="text-sm font-semibold text-text-light dark:text-text-dark">
                                    {{ project.start_date|date:"M d, Y" }}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if project.end_date %}
                        <div class="flex gap-3">
                            <div class="flex flex-col items-center">
                                <div class="w-3 h-3 bg-error rounded-full ring-4 ring-error/10"></div>
                            </div>
                            <div>
                                <div class="text-xs text-error uppercase font-bold tracking-wide mb-0.5">{% trans "End Date" %}</div>
                                <div class="text-sm font-semibold text-text-light dark:text-text-dark">
                                    {{ project.end_date|date:"M d, Y" }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark text-xs text-text-light-secondary dark:text-text-dark-secondary">
                        <i class="fas fa-clock mr-1"></i> {% trans "Posted" %}: {{ project.created_at|date:"M d, Y" }}
                    </div>
                </div>

                <!-- Related Success Stories -->
                {% if related_success_stories %}
                <div class="bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-text-light dark:text-text-dark mb-4 flex items-center">
                        <i class="fas fa-trophy text-warning mr-2"></i>
                        {% trans "Success Stories" %}
                    </h3>
                    <div class="space-y-4">
                        {% for story in related_success_stories %}
                        <a href="{% url 'content_success_story_detail' story.pk %}" class="block group">
                            <div class="p-4 bg-light-secondary-bg dark:bg-dark-bg border border-border-light dark:border-border-dark rounded-xl hover:border-warning/50 transition-all duration-300">
                                <h4 class="font-bold text-text-light dark:text-text-dark mb-2 group-hover:text-warning transition-colors line-clamp-2 text-sm leading-snug">
                                    {{ story.title }}
                                </h4>
                                <div class="flex items-center justify-between text-xs text-text-light-secondary dark:text-text-dark-secondary">
                                    <span class="flex items-center gap-1">
                                        <i class="fas fa-calendar-alt"></i>
                                        {{ story.published_at|date:"M d, Y" }}
                                    </span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    <a href="{% url 'content_success_story_list' %}" class="block mt-5 w-full text-center px-4 py-2 text-sm font-semibold text-warning border border-warning/30 rounded-lg hover:bg-warning/10 transition-colors">
                        {% trans "View All Stories" %} <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
                {% endif %}

                <!-- Related Projects -->
                {% if related_projects %}
                <div class="bg-light-bg dark:bg-dark-secondary-bg border border-border-light dark:border-border-dark rounded-2xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-text-light dark:text-text-dark mb-4 flex items-center">
                        <i class="fas fa-project-diagram text-primary-blue mr-2"></i>
                        {% trans "Related Projects" %}
                    </h3>
                    <div class="space-y-4">
                        {% for rel_project in related_projects %}
                        <a href="{% url 'content_project_detail' rel_project.pk %}" class="block group">
                            <div class="p-4 bg-light-secondary-bg dark:bg-dark-bg border border-border-light dark:border-border-dark rounded-xl hover:border-primary-blue/50 transition-all duration-300">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 bg-primary-blue/10 dark:bg-light-bg/10 text-primary-blue dark:text-text-dark text-[10px] font-bold rounded-full">
                                        {{ rel_project.country }}
                                    </span>
                                </div>
                                <h4 class="font-bold text-text-light dark:text-text-dark mb-2 group-hover:text-primary-blue dark:group-hover:text-accent-light transition-colors line-clamp-2 text-sm leading-snug">
                                    {{ rel_project.title }}
                                </h4>
                                <div class="flex items-center gap-3 text-xs text-text-light-secondary dark:text-text-dark-secondary">
                                    <span class="flex items-center gap-1">
                                        <i class="fas fa-users"></i>
                                        {{ rel_project.headcount|default:0 }}/{{ rel_project.total_headcount|default:0 }}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <i class="fas fa-clock"></i>
                                        {{ rel_project.duration }}h
                                    </span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    <a href="{% url 'content_project_list' %}" class="block mt-5 w-full text-center px-4 py-2 text-sm font-semibold text-primary-blue dark:text-white border border-primary-blue/30 dark:border-light-bg rounded-lg hover:bg-primary-blue/10 dark:hover:bg-light-bg/10 transition-colors">
                        {% trans "View All Projects" %} <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Media Gallery -->
    {% if project.gallery_images.all or project.image_urls or project.video_urls %}
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
        <div class="bg-light-bg dark:bg-dark-secondary-bg rounded-2xl shadow-sm border border-border-light dark:border-border-dark p-6 md:p-8">
            <h3 class="text-2xl font-bold text-primary-blue dark:text-text-dark mb-6 flex items-center">
                <i class="fas fa-images text-accent-blue mr-3 p-2 bg-accent-blue/10 rounded-lg"></i>
                {% trans "Media Gallery" %}
            </h3>
            <style>
                .gallery-container {
                    column-count: 1;
                    column-gap: 16px;
                    column-fill: balance;
                    width: 100%;
                }

                @media (min-width: 640px) {
                    .gallery-container {
                        column-count: 2;
                    }
                }

                @media (min-width: 1024px) {
                    .gallery-container {
                        column-count: 3;
                    }
                }

                .gallery-item {
                    break-inside: avoid;
                    position: relative;
                    overflow: hidden;
                    border-radius: 0.75rem;
                    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                    transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
                    cursor: zoom-in;
                    background: #e5e7eb; /* bg-gray-200 placeholder */
                    margin-bottom: 16px;
                    display: block;
                    width: 100%;
                }

                .dark .gallery-item {
                    background: #374151; /* bg-gray-700 placeholder */
                }

                .gallery-item:hover {
                    transform: translateY(-4px);
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    z-index: 10;
                }

                .gallery-item img {
                    width: 100%;
                    height: auto;
                    display: block;
                    object-fit: cover;
                }
                
                /* Overlay on hover */
                .gallery-item::after {
                    content: '';
                    position: absolute;
                    inset: 0;
                    background: rgba(0,0,0,0);
                    transition: background 0.3s ease;
                }
                .gallery-item:hover::after {
                    background: rgba(0,0,0,0.1);
                }

                .gallery-item video,
                .gallery-item iframe {
                    width: 100%;
                    height: auto;
                    display: block;
                }

                .gallery-item.video-container,
                .gallery-item.iframe-container {
                    aspect-ratio: 16 / 9;
                }

                .gallery-item.iframe-container.shorts {
                    aspect-ratio: 9 / 16;
                }

                .gallery-item.video-container video,
                .gallery-item.iframe-container iframe {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                /* Icon overlay for video */
                .gallery-item[data-type="video"]::before {
                    content: '\f144'; /* fa-play-circle */
                    font-family: 'Font Awesome 5 Free';
                    font-weight: 900;
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) scale(0.8);
                    font-size: 3rem;
                    color: white;
                    opacity: 0;
                    z-index: 20;
                    transition: all 0.3s ease;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    pointer-events: none;
                }
                .gallery-item[data-type="video"]:hover::before {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }

                /* Gallery Lightbox Styles */
                .gallery-lightbox {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(15, 23, 42, 0.95); /* dark-bg with opacity */
                    z-index: 9999;
                    justify-content: center;
                    align-items: center;
                    animation: fadeIn 300ms ease-in-out;
                    backdrop-filter: blur(5px);
                }

                .gallery-lightbox.active {
                    display: flex;
                }

                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }

                .gallery-lightbox-content {
                    position: relative;
                    max-width: 95vw;
                    max-height: 95vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: slideIn 300ms ease-in-out;
                }

                @keyframes slideIn {
                    from { transform: scale(0.95); opacity: 0; }
                    to { transform: scale(1); opacity: 1; }
                }

                .gallery-lightbox-media {
                    max-width: 90vw;
                    max-height: 90vh;
                    object-fit: contain;
                    border-radius: 0.5rem;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                }

                .gallery-lightbox-close {
                    position: fixed;
                    top: 24px;
                    right: 24px;
                    font-size: 24px;
                    color: white;
                    cursor: pointer;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    width: 48px;
                    height: 48px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 200ms ease-in-out;
                    z-index: 10001;
                }

                .gallery-lightbox-close:hover {
                    background: rgba(255, 255, 255, 0.2);
                    transform: rotate(90deg);
                }

                .gallery-lightbox-nav {
                    position: fixed;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 20px;
                    color: white;
                    cursor: pointer;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    width: 56px;
                    height: 56px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 200ms ease-in-out;
                    z-index: 10001;
                }

                .gallery-lightbox-nav:hover {
                    background: rgba(255, 255, 255, 0.2);
                    transform: translateY(-50%) scale(1.1);
                }

                .gallery-lightbox-nav.prev { left: 24px; }
                .gallery-lightbox-nav.next { right: 24px; }

                .gallery-lightbox-nav:disabled {
                    opacity: 0.3;
                    cursor: not-allowed;
                    transform: translateY(-50%);
                }

                .gallery-lightbox-counter {
                    position: fixed;
                    bottom: 24px;
                    left: 50%;
                    transform: translateX(-50%);
                    color: white;
                    background: rgba(0, 0, 0, 0.5);
                    padding: 8px 16px;
                    border-radius: 999px;
                    font-size: 14px;
                    font-weight: 500;
                    letter-spacing: 0.05em;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(4px);
                    z-index: 10001;
                }

                @media (max-width: 640px) {
                    .gallery-lightbox-nav {
                        width: 44px;
                        height: 44px;
                        font-size: 18px;
                        background: rgba(0,0,0,0.3);
                    }
                    .gallery-lightbox-nav.prev { left: 12px; }
                    .gallery-lightbox-nav.next { right: 12px; }
                    .gallery-lightbox-close { top: 16px; right: 16px; background: rgba(0,0,0,0.3); }
                }
            </style>

            <div class="gallery-container">
                {# Display Unified Gallery Items (Blobs, URLs, Videos) - Paginated #}
                {% for item in gallery_items %}
                    {% if item.type == 'blob_image' %}
                        <div class="gallery-item" data-index="{{ item.index }}" data-type="image">
                            <img src="{% url 'content_serve_blob' 'project_gallery_image' item.object.pk 'image_blob' %}" 
                                    alt="{% if item.caption %}{{ item.caption }}{% else %}{% trans "Project - Gallery Image" %} {{ forloop.counter }}{% endif %}" 
                                    loading="lazy" 
                                    data-src="{% url 'content_serve_blob' 'project_gallery_image' item.object.pk 'image_blob' %}">
                        </div>
                    {% elif item.type == 'image_url' %}
                        <div class="gallery-item" data-index="{{ item.index }}" data-type="image">
                            {% if 'drive.google.com' in item.url %}
                                <img src="{{ item.url|google_drive_image_embed }}" 
                                        alt="{% blocktrans with num=forloop.counter %}Project - Gallery Image {{ num }}{% endblocktrans %}" 
                                        loading="lazy" 
                                        data-src="{{ item.url|google_drive_image_embed }}">
                            {% else %}
                                <img src="{{ item.url }}" 
                                        alt="{% blocktrans with num=forloop.counter %}Project - Gallery Image {{ num }}{% endblocktrans %}" 
                                        loading="lazy" 
                                        data-src="{{ item.url }}">
                            {% endif %}
                        </div>
                    {% elif item.type == 'video_url' %}
                        {% if 'youtube.com/shorts' in item.url %}
                            <div class="gallery-item iframe-container shorts" data-index="{{ item.index }}" data-type="video">
                        {% else %}
                            <div class="gallery-item video-container" data-index="{{ item.index }}" data-type="video">
                        {% endif %}
                            {% if 'youtube.com' in item.url or 'youtu.be' in item.url %}
                                <iframe id="youtube-player-{{ forloop.counter }}"
                                        src="{{ item.url|embed_youtube }}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                        allowfullscreen
                                        referrerpolicy="strict-origin-when-cross-origin"
                                        title="{% blocktrans with num=forloop.counter %}Project - YouTube Video {{ num }}{% endblocktrans %}"
                                        loading="lazy"
                                        data-video-url="{{ item.url|embed_youtube }}">
                                </iframe>
                            {% elif 'drive.google.com' in item.url %}
                                <iframe src="{{ item.url|google_drive_video_embed }}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen
                                        title="{% blocktrans with num=forloop.counter %}Project - Google Drive Video {{ num }}{% endblocktrans %}"
                                        loading="lazy"
                                        data-video-url="{{ item.url|google_drive_video_embed }}">
                                </iframe>
                            {% else %}
                                <video controls 
                                        preload="none"
                                        title="{% blocktrans with num=forloop.counter %}Project - Video {{ num }}{% endblocktrans %}"
                                        poster=""
                                        data-video-url="{{ item.url }}">
                                    <source src="{{ item.url }}" type="video/mp4">
                                    {% trans "Your browser does not support the video tag." %}
                                </video>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            {# Gallery Pagination #}
            {% if gallery_items.has_other_pages %}
            <div class="flex justify-center mt-8">
                <nav class="flex items-center space-x-2" aria-label="Gallery pagination">
                    {% if gallery_items.has_previous %}
                        <a href="?{% if request.GET.gallery_page %}gallery_page={{ gallery_items.previous_page_number }}{% else %}gallery_page=1{% endif %}"
                           class="px-4 py-2 text-sm font-medium text-primary-blue bg-white border border-border-light rounded-lg hover:bg-primary-blue hover:text-white transition-colors duration-200">
                            {% trans "Previous" %}
                        </a>
                    {% endif %}
                    
                    <span class="px-4 py-2 text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary">
                        {% blocktrans with current=gallery_items.number total=gallery_paginator.num_pages %}
                            Page {{ current }} of {{ total }}
                        {% endblocktrans %}
                    </span>
                    
                    {% if gallery_items.has_next %}
                        <a href="?gallery_page={{ gallery_items.next_page_number }}"
                           class="px-4 py-2 text-sm font-medium text-primary-blue bg-white border border-border-light rounded-lg hover:bg-primary-blue hover:text-white transition-colors duration-200">
                            {% trans "Next" %}
                        </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}

            <!-- Gallery Lightbox Modal -->
            <div class="gallery-lightbox" id="galleryLightbox">
                <div class="gallery-lightbox-content">
                <button class="gallery-lightbox-close" id="closeLightbox" aria-label="{% trans "Close gallery" %}">
                    <i class="fas fa-times"></i>
                </button>
                
                <button class="gallery-lightbox-nav prev" id="prevBtn" aria-label="{% trans "Previous image" %}">
                    <i class="fas fa-chevron-left"></i>
                </button>

                <div id="lightboxMediaContainer" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                    <!-- Media will be inserted here -->
                </div>

                <button class="gallery-lightbox-nav next" id="nextBtn" aria-label="{% trans "Next image" %}">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="gallery-lightbox-counter">
                        <span id="currentIndex">1</span> / <span id="totalItems">1</span>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <script>
        // Load YouTube iframe API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let players = [];
        let playerStates = {};

        // YouTube API ready callback
        function onYouTubeIframeAPIReady() {
            // Find all YouTube iframes in gallery
            document.querySelectorAll('.gallery-item iframe[src*="youtube.com/embed"]').forEach((iframe, index) => {
                // Add enablejsapi parameter to iframe src if not present
                if (!iframe.src.includes('enablejsapi')) {
                    const separator = iframe.src.includes('?') ? '&' : '?';
                    iframe.src = iframe.src + separator + 'enablejsapi=1';
                }
                
                // Give iframe an ID if it doesn't have one
                if (!iframe.id) {
                    iframe.id = 'youtube-player-' + index;
                }
                
                // Create player
                const player = new YT.Player(iframe.id, {
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
                
                players.push(player);
                playerStates[iframe.id] = player;
            });
        }

        // Handle YouTube player state changes
        function onPlayerStateChange(event) {
            // YT.PlayerState.PLAYING = 1
            if (event.data == YT.PlayerState.PLAYING) {
                // Pause all other YouTube videos
                players.forEach(player => {
                    if (player !== event.target) {
                        try {
                            player.pauseVideo();
                        } catch (e) {
                            // Player might not be ready
                        }
                    }
                });
                
                // Pause all HTML5 videos
                document.querySelectorAll('.gallery-item video').forEach(video => {
                    if (!video.paused) {
                        video.pause();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Gallery Lightbox Functionality
            const galleryLightbox = document.getElementById('galleryLightbox');
            const lightboxMediaContainer = document.getElementById('lightboxMediaContainer');
            const closeLightboxBtn = document.getElementById('closeLightbox');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentIndexSpan = document.getElementById('currentIndex');
            const totalItemsSpan = document.getElementById('totalItems');
            
            let galleryItems = [];
            let currentIndex = 0;
            let currentlyPlayingVideo = null;

            // Pause all playing videos
            function pauseAllVideos() {
                // Pause all YouTube videos using API
                players.forEach(player => {
                    try {
                        if (player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
                            player.pauseVideo();
                        }
                    } catch (e) {
                        // Player might not be ready
                    }
                });
                
                // Pause all HTML5 video elements in the gallery
                document.querySelectorAll('.gallery-item video').forEach(video => {
                    if (!video.paused) {
                        video.pause();
                    }
                });
                
                // Pause all other iframe videos (Google Drive, etc)
                document.querySelectorAll('.gallery-item iframe:not([src*="youtube.com/embed"])').forEach(iframe => {
                    const iframeSrc = iframe.src;
                    if (iframeSrc && iframeSrc.includes('drive.google.com')) {
                        iframe.src = iframeSrc;
                    }
                });
            }

            // Collect all gallery items
            function initGallery() {
                galleryItems = Array.from(document.querySelectorAll('.gallery-item'));
                if (totalItemsSpan) totalItemsSpan.textContent = galleryItems.length;
                
                // Add click handlers to gallery items
                galleryItems.forEach((item, index) => {
                    // Only open lightbox if clicked on the container, not the controls of a video
                    item.addEventListener('click', (e) => {
                        // For videos with controls, we might want to let the user play inline
                        // But for consistency, let's open lightbox for everything if clicked outside controls
                        if (e.target.tagName !== 'VIDEO' && e.target.tagName !== 'IFRAME') {
                           openLightbox(index);
                        }
                    });
                });
                
                // Add play event listeners to all HTML5 video elements
                document.querySelectorAll('.gallery-item video').forEach(video => {
                    video.addEventListener('play', () => {
                        // Pause all YouTube videos
                        players.forEach(player => {
                            try {
                                if (player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
                                    player.pauseVideo();
                                }
                            } catch (e) {
                                // Player might not be ready
                            }
                        });
                        
                        // Pause all other HTML5 videos
                        document.querySelectorAll('.gallery-item video').forEach(otherVideo => {
                            if (otherVideo !== video && !otherVideo.paused) {
                                otherVideo.pause();
                            }
                        });
                    });
                });
            }

            // Open lightbox with specific item
            function openLightbox(index) {
                currentIndex = index;
                pauseAllVideos(); // Pause all videos before opening lightbox
                galleryLightbox.classList.add('active');
                displayMedia(currentIndex);
                document.body.style.overflow = 'hidden';
                updateNavButtons();
            }

            // Close lightbox
            function closeLightbox() {
                pauseAllVideos(); // Pause all videos when closing lightbox
                galleryLightbox.classList.remove('active');
                document.body.style.overflow = 'auto';
                lightboxMediaContainer.innerHTML = '';
            }

            // Display media in lightbox
            function displayMedia(index) {
                const item = galleryItems[index];
                if (currentIndexSpan) currentIndexSpan.textContent = index + 1;
                
                lightboxMediaContainer.innerHTML = '';

                const itemType = item.getAttribute('data-type');
                
                if (itemType === 'image') {
                    const img = item.querySelector('img');
                    if (img) {
                        const fullSrc = img.getAttribute('data-src') || img.getAttribute('src');
                        const lightboxImg = document.createElement('img');
                        lightboxImg.src = fullSrc;
                        lightboxImg.alt = img.alt;
                        lightboxImg.className = 'gallery-lightbox-media';
                        lightboxMediaContainer.appendChild(lightboxImg);
                    }
                } else if (itemType === 'video') {
                    const iframe = item.querySelector('iframe');
                    const video = item.querySelector('video');
                    
                    if (iframe) {
                        const lightboxIframe = document.createElement('iframe');
                        lightboxIframe.src = iframe.src;
                        lightboxIframe.frameborder = '0';
                        lightboxIframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                        lightboxIframe.referrerPolicy = 'strict-origin-when-cross-origin';
                        lightboxIframe.title = iframe.title || 'Video';
                        lightboxIframe.allowFullscreen = true;
                        lightboxIframe.loading = 'lazy';
                        
                        // Detect if it's a YouTube Shorts video
                        const isShorts = item.classList.contains('shorts');
                        
                        lightboxIframe.style.maxWidth = '100%';
                        lightboxIframe.style.maxHeight = '100%';
                        lightboxIframe.style.width = isShorts ? '50vw' : '90vw';
                        lightboxIframe.style.height = '90vh';
                        lightboxIframe.style.aspectRatio = isShorts ? '9/16' : '16/9';
                        lightboxIframe.style.objectFit = 'contain';
                        lightboxIframe.style.borderRadius = '0.5rem';
                        lightboxMediaContainer.appendChild(lightboxIframe);
                    } else if (video) {
                        const lightboxVideo = document.createElement('video');
                        lightboxVideo.controls = true;
                        lightboxVideo.className = 'gallery-lightbox-media';
                        lightboxVideo.style.maxWidth = '90vw';
                        lightboxVideo.style.maxHeight = '90vh';
                        lightboxVideo.style.objectFit = 'contain';
                        const source = document.createElement('source');
                        source.src = video.querySelector('source')?.src;
                        source.type = 'video/mp4';
                        lightboxVideo.appendChild(source);
                        
                        // Add play listener to pause other videos
                        lightboxVideo.addEventListener('play', () => {
                            pauseAllVideos();
                            lightboxVideo.play();
                        });
                        
                        lightboxMediaContainer.appendChild(lightboxVideo);
                    }
                }
            }

            // Update navigation button states
            function updateNavButtons() {
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex === galleryItems.length - 1;
            }

            // Navigation functions
            function showPrevious() {
                if (currentIndex > 0) {
                    currentIndex--;
                    displayMedia(currentIndex);
                    updateNavButtons();
                }
            }

            function showNext() {
                if (currentIndex < galleryItems.length - 1) {
                    currentIndex++;
                    displayMedia(currentIndex);
                    updateNavButtons();
                }
            }

            // Event listeners
            if (closeLightboxBtn) closeLightboxBtn.addEventListener('click', closeLightbox);
            if (prevBtn) prevBtn.addEventListener('click', showPrevious);
            if (nextBtn) nextBtn.addEventListener('click', showNext);

            // Close on background click
            if (galleryLightbox) {
                galleryLightbox.addEventListener('click', (e) => {
                    if (e.target === galleryLightbox || e.target.classList.contains('gallery-lightbox-content')) {
                        closeLightbox();
                    }
                });
            }

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (galleryLightbox && !galleryLightbox.classList.contains('active')) return;
                
                if (e.key === 'ArrowLeft') {
                    showPrevious();
                } else if (e.key === 'ArrowRight') {
                    showNext();
                } else if (e.key === 'Escape') {
                    closeLightbox();
                }
            });

            // Initialize Intersection Observer for lazy loading
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        
                        // Handle images
                        if (img.tagName === 'IMG') {
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                            }
                            img.classList.remove('lazy');
                            observer.unobserve(img);
                        }
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });

            // Observe all lazy-loaded images
            document.querySelectorAll('.gallery-item img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });

            // Initialize gallery
            initGallery();

            // Auto-scroll to gallery if gallery_page parameter is present in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('gallery_page')) {
                // Small delay to ensure page is fully loaded
                setTimeout(() => {
                    const galleryContainer = document.querySelector('.gallery-container');
                    if (galleryContainer) {
                        galleryContainer.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }, 500);
            }

            // Add scroll-to-gallery functionality for pagination links
            const paginationLinks = document.querySelectorAll('a[href*="gallery_page"]');
            paginationLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // Small delay to allow page to load before scrolling
                    setTimeout(() => {
                        const galleryContainer = document.querySelector('.gallery-container');
                        if (galleryContainer) {
                            galleryContainer.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }, 100);
                });
            });
        });

        // Fallback for browsers without native lazy loading support
        if (!('loading' in HTMLImageElement.prototype)) {
            document.addEventListener('scroll', () => {
                document.querySelectorAll('img[loading="lazy"]').forEach(img => {
                    if (img.offsetParent === null) return;
                    
                    const rect = img.getBoundingClientRect();
                    if (rect.top < window.innerHeight + 50 && rect.bottom > -50) {
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                        }
                    }
                });
            });
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const maxHeight = '15em';
            
            // Function to handle read more for a container and button
            // Optional third parameter `maxHeightOverride` can be passed like '4.5em'.
            function setupReadMore(containerId, buttonId, maxHeightOverride) {
                const content = document.getElementById(containerId);
                const btn = document.getElementById(buttonId);
                const effectiveMax = maxHeightOverride || maxHeight;
                
                if (!content || !btn) return;

                // Store any line-clamp classes present on the container or its descendants
                // We'll gather initial elements and their clamp classes so we can re-apply them when collapsing.
                const clampElements = [];
                // If self has line-clamp classes
                Array.from(content.classList).forEach(c => { if (c.startsWith('line-clamp-')) clampElements.push({el: content, cls: c}); });
                // Descendants with clamp classes
                Array.from(content.querySelectorAll('*')).forEach(el => {
                    Array.from(el.classList).forEach(c => { if (c.startsWith('line-clamp-')) clampElements.push({el: el, cls: c}); });
                });

                if (content.scrollHeight > parseFloat(effectiveMax) * 16) {
                    content.style.maxHeight = effectiveMax;
                    content.style.overflow = 'hidden';
                    btn.classList.remove('hidden');
                }

                btn.addEventListener('click', function() {
                    const isCollapsed = !!content.style.maxHeight && content.style.maxHeight !== '';

                    if (isCollapsed) {
                        // Expand
                        content.style.maxHeight = '';
                        content.style.overflow = '';
                        // Update button text
                        const lessText = btn.dataset.less || 'Read Less';
                        btn.innerHTML = `${lessText} <i class="fas fa-chevron-up ml-1"></i>`;
                        // Remove clamp classes to allow full rendering (if present)
                        clampElements.forEach(item => {
                            try { item.el.classList.remove(item.cls); } catch (e) {}
                        });
                    } else {
                        // Collapse
                        content.style.maxHeight = effectiveMax;
                        content.style.overflow = 'hidden';
                        // Update button text
                        const moreText = btn.dataset.more || 'Read More';
                        btn.innerHTML = `${moreText} <i class="fas fa-chevron-down ml-1"></i>`;
                        // Re-apply clamp classes that existed initially
                        clampElements.forEach(item => {
                            try { item.el.classList.add(item.cls); } catch (e) {}
                        });
                    }
                });
            }
            
            setupReadMore('content-container-bg', 'read-more-btn-bg');
            setupReadMore('content-container-tasks', 'read-more-btn-tasks');
            // Limit teaser to ~3 lines and show read more if longer
            setupReadMore('content-container-teaser', 'read-more-btn-teaser', '5.5em');
        });
    </script>

    <script>
        // Add fallback / enhancement for anchor link smooth scrolling and hash updates
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
                    anchor.addEventListener('click', function(e) {
                        var target = this.getAttribute('href');
                        if (!target || target === '#') return;
                        var el = document.querySelector(target);
                        if (el) {
                            e.preventDefault();
                            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            try { history.pushState(null, null, target); } catch (err) {}
                        }
                    });
                });
            });
        })();
    </script>

{% endblock %}

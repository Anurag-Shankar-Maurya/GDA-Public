{% extends 'content_management_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Analytics Dashboard" %}{% endblock %}

{% block breadcrumb %}
<li class="flex items-center">
    <a href="{% url 'management_dashboard' %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200">{% trans "Dashboard" %}</a>
</li>
{% endblock %}

{% block content %}
<!-- Modern Gradient Header Section -->
<div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-800 rounded-xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden">
    <div class="absolute inset-0 bg-black bg-opacity-20"></div>
    <div class="relative z-10">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold mb-2 flex items-center">
                    <i class="fas fa-tachometer-alt mr-4 text-yellow-300"></i>
                    {% trans "Analytics Dashboard" %}
                </h1>
                <p class="text-blue-100 text-lg md:text-xl">{% trans "Comprehensive overview of your content management system" %}</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-sm text-blue-200">{% trans "Last Updated" %}</p>
                    <p class="text-lg font-semibold">{{ last_updated|default:"Just now" }}</p>
                </div>
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-chart-line text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Quick Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8 pt-6 border-t border-white border-opacity-20">
            <div class="text-center">
                <div class="text-2xl md:text-3xl font-bold text-yellow-300">{{ total_projects }}</div>
                <div class="text-sm text-blue-200">{% trans "Projects" %}</div>
            </div>
            <div class="text-center">
                <div class="text-2xl md:text-3xl font-bold text-green-300">{{ total_users }}</div>
                <div class="text-sm text-blue-200">{% trans "Total Users" %}</div>
            </div>
            <div class="text-center">
                <div class="text-2xl md:text-3xl font-bold text-purple-300">{{ total_beneficiaries }}</div>
                <div class="text-sm text-blue-200">{% trans "Beneficiaries" %}</div>
            </div>
            <div class="text-center">
                <div class="text-2xl md:text-3xl font-bold text-pink-300">{{ total_gallery_images }}</div>
                <div class="text-sm text-blue-200">{% trans "Gallery Images" %}</div>
            </div>
        </div>
    </div>
</div>

<div class="container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

    <!-- Enhanced Analytics Navigation -->
    <div class="mb-8">
        <div class="bg-white dark:bg-card-bg-dark rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-bar mr-3 text-primary-blue"></i>
                {% trans "Detailed Analytics" %}
            </h2>
            <div class="flex flex-wrap gap-4">
                <a href="{% url 'user_analytics' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-users mr-3"></i>
                    {% trans "User Analytics" %}
                    <i class="fas fa-arrow-right ml-3"></i>
                </a>
                <a href="{% url 'application_analytics' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-chart-pie mr-3"></i>
                    {% trans "Application Analytics" %}
                    <i class="fas fa-arrow-right ml-3"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Enhanced Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
        <!-- Users Card -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Total Users" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ total_users }}</p>
                <p class="text-sm opacity-80 mt-1">+{{ new_users_30d }} {% trans "new (30d)" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-users"></i>
            </div>
        </div>

        <!-- Projects Card -->
        <div class="bg-gradient-to-r from-green-500 to-teal-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Active Projects" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ active_projects }}</p>
                <p class="text-sm opacity-80 mt-1">{{ utilization_rate }}% {% trans "Utilization" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-play-circle"></i>
            </div>
        </div>

        <!-- News Card -->
        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "News & Events" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ total_news_events }}</p>
                <p class="text-sm opacity-80 mt-1">{{ published_news_events }} {% trans "Published" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-newspaper"></i>
            </div>
        </div>

        <!-- Stories Card -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Success Stories" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ total_success_stories }}</p>
                <p class="text-sm opacity-80 mt-1">{% trans "Impact stories" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-trophy"></i>
            </div>
        </div>

        <!-- FAQs Card -->
        <div class="bg-gradient-to-r from-red-500 to-rose-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Total FAQs" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ total_faqs }}</p>
                <p class="text-sm opacity-80 mt-1">{% trans "Help content" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-question-circle"></i>
            </div>
        </div>

        <!-- Beneficiaries Card -->
        <div class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Total Beneficiaries" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ total_beneficiaries }}</p>
                <p class="text-sm opacity-80 mt-1">{% trans "People helped" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-users"></i>
            </div>
        </div>

        <!-- Hours Card -->
        <div class="bg-gradient-to-r from-pink-500 to-fuchsia-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Hours Contributed" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ total_hours_contributed }}</p>
                <p class="text-sm opacity-80 mt-1">{% trans "Community effort" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-hourglass-half"></i>
            </div>
        </div>
        
        <!-- Capacity Card -->
        <div class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Total Capacity" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ total_capacity }}</p>
                <p class="text-sm opacity-80 mt-1">{{ total_enrolled }} {% trans "Enrolled" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-chair"></i>
            </div>
        </div>

        <!-- Upcoming Deadlines Card -->
        <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Upcoming Deadlines" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ upcoming_deadlines }}</p>
                <p class="text-sm opacity-80 mt-1">{% trans "Next 30 days" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-calendar-alt"></i>
            </div>
        </div>

        <!-- Featured Content Card -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Featured Content" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ featured_projects|add:featured_news|add:featured_stories }}</p>
                <p class="text-sm opacity-80 mt-1">{% trans "Projects, News & Stories" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-star"></i>
            </div>
        </div>

        <!-- User Engagement Card -->
        <div class="bg-gradient-to-r from-teal-500 to-green-500 text-white shadow-lg rounded-xl p-6 flex items-center justify-between hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group">
            <div>
                <h3 class="text-lg font-medium mb-1">{% trans "Active Users (30d)" %}</h3>
                <p class="text-4xl font-bold group-hover:scale-110 transition-transform duration-300">{{ active_users_30d }}</p>
                <p class="text-sm opacity-80 mt-1">{{ onboarding_rate }}% {% trans "Onboarded" %}</p>
            </div>
            <div class="text-5xl opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <i class="fas fa-user-check"></i>
            </div>
        </div>
    </div>

    <!-- Data Visualization & Content Analytics -->
    <div class="mb-12">
        <!-- Dashboard Filter Controls -->
        <div class="bg-white dark:bg-card-bg-dark rounded-xl shadow-md p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-chart-line mr-3 text-primary-blue"></i>
                {% trans "Analytics Overview" %}
            </h2>
            <div class="flex flex-wrap gap-3">
                <div class="flex items-center space-x-2">
                    <label for="timeRange" class="text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Range:" %}</label>
                    <select id="timeRange" class="form-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="30d">{% trans "Last 30 Days" %}</option>
                        <option value="90d">{% trans "Last 90 Days" %}</option>
                        <option value="6m" selected>{% trans "Last 6 Months" %}</option>
                        <option value="1y">{% trans "Last Year" %}</option>
                        <option value="all">{% trans "All Time" %}</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="frequency" class="text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Freq:" %}</label>
                    <select id="frequency" class="form-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="day">{% trans "Daily" %}</option>
                        <option value="week">{% trans "Weekly" %}</option>
                        <option value="month" selected>{% trans "Monthly" %}</option>
                    </select>
                </div>
                <button id="refreshData" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition-colors duration-200">
                    <i class="fas fa-sync-alt mr-2"></i> {% trans "Refresh" %}
                </button>
                
                <!-- Export Dropdown -->
                <div class="relative inline-block text-left">
                    <button type="button" id="exportMenuBtn" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:hover:bg-gray-600 transition-colors duration-200" aria-expanded="false" aria-haspopup="true">
                        <i class="fas fa-download mr-2"></i> {% trans "Export" %}
                        <i class="fas fa-chevron-down ml-2"></i>
                    </button>
                    <!-- Dropdown menu -->
                    <div id="exportMenu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-50 transition-all duration-200 ease-out transform opacity-0 scale-95">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="exportMenuBtn">
                            <button id="exportPDF" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150" role="menuitem">
                                <i class="fas fa-file-pdf mr-2 text-red-500"></i> {% trans "Export as PDF" %}
                            </button>
                            <button id="exportCSV" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150" role="menuitem">
                                <i class="fas fa-file-csv mr-2 text-green-500"></i> {% trans "Export as CSV" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- User Growth Chart -->
            <div class="chart-container bg-white dark:bg-card-bg-dark p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "User Growth" %}</h3>
                <div class="relative h-72">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>

            <!-- Content Activity Chart -->
            <div class="chart-container bg-white dark:bg-card-bg-dark p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "Content Creation Activity" %}</h3>
                <div class="relative h-72">
                    <canvas id="contentActivityChart"></canvas>
                </div>
            </div>

            <!-- Projects by Theme -->
            <div class="chart-container bg-white dark:bg-card-bg-dark p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "Projects by Theme" %}</h3>
                <div class="relative h-72">
                    <canvas id="projectThemeChart"></canvas>
                </div>
            </div>

            <!-- Projects by Country -->
            <div class="chart-container bg-white dark:bg-card-bg-dark p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "Projects by Country" %}</h3>
                <div class="relative h-72">
                    <canvas id="projectCountryChart"></canvas>
                </div>
            </div>

            <!-- User Gender Distribution -->
            <div class="chart-container bg-white dark:bg-card-bg-dark p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "User Gender Distribution" %}</h3>
                <div class="relative h-72">
                    <canvas id="userGenderChart"></canvas>
                </div>
            </div>

            <!-- Project Difficulty -->
            <div class="chart-container bg-white dark:bg-card-bg-dark p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "Projects by Difficulty" %}</h3>
                <div class="relative h-72">
                    <canvas id="projectDifficultyChart"></canvas>
                </div>
            </div>
            
            <!-- Beneficiaries Impact -->
            <div class="chart-container bg-white dark:bg-card-bg-dark p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 lg:col-span-2">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "Top 5 Projects by Impact (Headcount)" %}</h3>
                <div class="relative h-72">
                    <canvas id="impactChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- User Demographics & Additional Stats Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- User Demographics -->
        <div class="bg-white dark:bg-card-bg-dark shadow-lg rounded-xl p-6 chart-container">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "User Demographics" %}</h3>
            <div>
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Top User Countries" %}</h4>
                <div class="relative h-72">
                    <canvas id="userCountryBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Login Methods & Engagement -->
        <div class="bg-white dark:bg-card-bg-dark shadow-lg rounded-xl p-6 chart-container">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "User Engagement" %}</h3>
            <div class="space-y-6">
                <div>
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Login Methods" %}</h4>
                    <div class="relative h-48">
                        <canvas id="loginMethodPieChart"></canvas>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Onboarding Complete" %}</span>
                        <span class="text-sm font-medium text-green-600">{{ onboarding_rate }}%</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Email Verified" %}</span>
                        <span class="text-sm font-medium text-blue-600">{{ verification_rate }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content & Impact Summary -->
    <div class="bg-white dark:bg-card-bg-dark shadow-lg rounded-xl p-6 mb-12 chart-container">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% trans "Content & Impact Summary" %}</h3>
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Avg Project Duration" %}</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ avg_project_duration }} {% trans "days" %}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Avg Beneficiaries/Story" %}</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ avg_beneficiaries_per_story }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Avg Hours/Story" %}</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ avg_hours_per_story }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Unique Enrolled Users" %}</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ unique_enrolled_users }}</span>
            </div>
            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Published Stories" %}</span>
                    <span class="text-sm font-medium text-green-600">{{ published_stories }}</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-sm text-gray-700 dark:text-gray-300">{% trans "Hero Highlights" %}</span>
                    <span class="text-sm font-medium text-yellow-600">{{ hero_projects|add:hero_news|add:hero_stories }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Recent Content Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Recent Projects -->
        <div class="bg-white dark:bg-card-bg-dark shadow-lg rounded-xl p-8 hover:shadow-2xl transition-all duration-300 border border-gray-100 dark:border-gray-700">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-folder-open mr-3 text-blue-500"></i>
                {% trans "Recent Projects" %}
                <span class="ml-auto text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">{{ recent_projects|length }}</span>
            </h3>
            <ul class="divide-y divide-gray-200 dark:divide-gray-700 space-y-1">
                {% for project in recent_projects %}
                <li class="py-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 py-2 transition-colors duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                            <i class="fas fa-project-diagram text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <a href="{% url 'project_detail' pk=project.pk %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 font-medium group-hover:underline transition-all duration-200">{{ project.title|truncatechars:25 }}</a>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ project.created_at|date:"M d, Y" }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if project.status == 'active' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                            {{ project.get_status_display|default:"Draft" }}
                        </span>
                    </div>
                </li>
                {% empty %}
                <li class="py-8 text-center">
                    <i class="fas fa-folder-open text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-gray-500 dark:text-gray-400">{% trans "No recent projects." %}</p>
                    <a href="{% url 'project_create' %}" class="inline-flex items-center mt-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i> {% trans "Create your first project" %}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% if recent_projects %}
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'project_list' %}" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 font-medium transition-colors duration-200">
                    {% trans "View all projects" %}
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Recent News & Events -->
        <div class="bg-white dark:bg-card-bg-dark shadow-lg rounded-xl p-8 hover:shadow-2xl transition-all duration-300 border border-gray-100 dark:border-gray-700">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-newspaper mr-3 text-yellow-500"></i>
                {% trans "Recent News & Events" %}
                <span class="ml-auto text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">{{ recent_news_events|length }}</span>
            </h3>
            <ul class="divide-y divide-gray-200 dark:divide-gray-700 space-y-1">
                {% for news in recent_news_events %}
                <li class="py-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 py-2 transition-colors duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                            <i class="fas fa-bullhorn text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <div>
                            <a href="{% url 'news_event_detail' pk=news.pk %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 font-medium group-hover:underline transition-all duration-200">{{ news.title|truncatechars:25 }}</a>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ news.publish_date|date:"M d, Y" }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if news.is_published %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300{% endif %}">
                            {% if news.is_published %}{% trans "Published" %}{% else %}{% trans "Draft" %}{% endif %}
                        </span>
                    </div>
                </li>
                {% empty %}
                <li class="py-8 text-center">
                    <i class="fas fa-newspaper text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-gray-500 dark:text-gray-400">{% trans "No recent news or events." %}</p>
                    <a href="{% url 'news_event_create' %}" class="inline-flex items-center mt-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i> {% trans "Create your first news item" %}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% if recent_news_events %}
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'news_event_list' %}" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 font-medium transition-colors duration-200">
                    {% trans "View all news & events" %}
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Recent Success Stories -->
        <div class="bg-white dark:bg-card-bg-dark shadow-lg rounded-xl p-8 hover:shadow-2xl transition-all duration-300 border border-gray-100 dark:border-gray-700">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-trophy mr-3 text-purple-500"></i>
                {% trans "Recent Success Stories" %}
                <span class="ml-auto text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">{{ recent_success_stories|length }}</span>
            </h3>
            <ul class="divide-y divide-gray-200 dark:divide-gray-700 space-y-1">
                {% for story in recent_success_stories %}
                <li class="py-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 py-2 transition-colors duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                            <i class="fas fa-star text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <div>
                            <a href="{% url 'success_story_detail' pk=story.pk %}" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 font-medium group-hover:underline transition-all duration-200">{{ story.title|truncatechars:25 }}</a>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ story.published_at|date:"M d, Y" }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if story.is_published %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300{% endif %}">
                            {% if story.is_published %}{% trans "Published" %}{% else %}{% trans "Draft" %}{% endif %}
                        </span>
                    </div>
                </li>
                {% empty %}
                <li class="py-8 text-center">
                    <i class="fas fa-trophy text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-gray-500 dark:text-gray-400">{% trans "No recent success stories." %}</p>
                    <a href="{% url 'success_story_create' %}" class="inline-flex items-center mt-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i> {% trans "Share your first success story" %}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% if recent_success_stories %}
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{% url 'success_story_list' %}" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 font-medium transition-colors duration-200">
                    {% trans "View all success stories" %}
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Data Filtering and Export (Placeholder)</h2>
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-8 text-gray-500 dark:text-gray-400">
            <p>Filtering controls (e.g., date range, content type) and export buttons (CSV, PDF) will be implemented here.</p>
            <button class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Export Data</button>
        </div>
    </div> -->

</div>

{% endblock %}

{% block static_js %}
<!-- Ensure Chart.js is loaded explicitly here -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<!-- Export Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Dashboard script loaded");

    // 1. Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error("Chart.js is not loaded!");
        return;
    }

    // Chart instances storage
    let chartInstances = {};
    let currentDashboardData = null; // Store data for CSV export

    // Base Chart Options
    const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
            }
        }
    };

    function isDarkMode() {
        return document.documentElement.classList.contains('dark');
    }

    function getChartColors() {
        const dark = isDarkMode();
        return {
            grid: dark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
            text: dark ? '#e5e7eb' : '#374151'
        };
    }

    // Initialize
    initCharts();

    function initCharts() {
        fetchData();
    }

    async function fetchData() {
        const range = document.getElementById('timeRange').value;
        const frequency = document.getElementById('frequency').value;
        const btn = document.getElementById('refreshData');
        
        // Save original icon to restore later
        const originalContent = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>';
        btn.disabled = true;

        try {
            const url = `{% url 'dashboard_data' %}?range=${range}&frequency=${frequency}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            currentDashboardData = data; // Store for export
            updateCharts(data);
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            btn.classList.add('bg-red-600'); // Visual error indication
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    function updateCharts(data) {
        const colors = getChartColors();
        const commonScales = {
            y: {
                beginAtZero: true,
                grid: { color: colors.grid, borderColor: colors.grid },
                ticks: { color: colors.text }
            },
            x: {
                grid: { color: colors.grid, borderColor: colors.grid },
                ticks: { color: colors.text }
            }
        };

        // 1. User Growth Chart
        updateChart('userGrowthChart', 'line', {
            labels: data.user_growth.labels,
            datasets: [{
                label: '{% trans "New Users" %}',
                data: data.user_growth.data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 6, // Fix: Make points visible for single data points
                pointHoverRadius: 8
            }]
        }, { scales: commonScales });

        // 2. Content Activity Chart
        updateChart('contentActivityChart', 'bar', {
            labels: data.content_activity.labels,
            datasets: [
                {
                    label: '{% trans "Projects" %}',
                    data: data.content_activity.datasets.projects,
                    backgroundColor: '#10b981',
                },
                {
                    label: '{% trans "News/Events" %}',
                    data: data.content_activity.datasets.news,
                    backgroundColor: '#f59e0b',
                },
                {
                    label: '{% trans "Stories" %}',
                    data: data.content_activity.datasets.stories,
                    backgroundColor: '#8b5cf6',
                }
            ]
        }, { 
            scales: {
                x: { ...commonScales.x, stacked: true },
                y: { ...commonScales.y, stacked: true }
            }
        });

        // 3. Projects by Theme
        updateChart('projectThemeChart', 'doughnut', {
            labels: data.themes.labels,
            datasets: [{
                data: data.themes.data,
                backgroundColor: [
                    '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'
                ],
                borderWidth: 0
            }]
        }, { 
            plugins: {
                legend: { position: 'right' }
            },
            scales: {} // Disable axes for doughnut
        });

        // 4. Projects by Country
        updateChart('projectCountryChart', 'bar', {
            labels: data.countries.labels,
            datasets: [{
                label: '{% trans "Projects" %}',
                data: data.countries.data,
                backgroundColor: '#6366f1',
                borderRadius: 4
            }]
        }, { scales: commonScales });

        // 6. User Gender Chart
        updateChart('userGenderChart', 'doughnut', {
            labels: data.demographics.gender.labels,
            datasets: [{
                data: data.demographics.gender.data,
                backgroundColor: ['#3b82f6', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6'],
                borderWidth: 0
            }]
        }, {
            plugins: { legend: { position: 'right' } },
            scales: {} 
        });

        // 7. Project Difficulty Chart
        updateChart('projectDifficultyChart', 'bar', {
            labels: data.project_difficulty.labels,
            datasets: [{
                label: '{% trans "Projects" %}',
                data: data.project_difficulty.data,
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], // Green, Yellow, Red logic roughly
                borderRadius: 4
            }]
        }, { scales: commonScales });
        
        // 5. Impact Chart
        updateChart('impactChart', 'bar', {
            labels: data.impact.labels,
            datasets: [{
                label: '{% trans "Beneficiaries (Headcount)" %}',
                data: data.impact.data,
                backgroundColor: '#ec4899',
                borderRadius: 4
            }]
        }, {
            indexAxis: 'y',
            scales: commonScales
        });

        // 8. User Countries (Bar)
        updateChart('userCountryBarChart', 'bar', {
            labels: data.demographics.countries.labels,
            datasets: [{
                label: '{% trans "Users" %}',
                data: data.demographics.countries.data,
                backgroundColor: '#6366f1',
                borderRadius: 4
            }]
        }, { scales: commonScales });

        // 9. Login Methods (Doughnut)
        updateChart('loginMethodPieChart', 'doughnut', {
            labels: data.demographics.login_methods.labels,
            datasets: [{
                data: data.demographics.login_methods.data,
                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
                borderWidth: 0
            }]
        }, {
            plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } },
            scales: {} 
        });
    }

    function updateChart(canvasId, type, data, optionsOverrides = {}) {
        const ctxElement = document.getElementById(canvasId);
        
        if (!ctxElement) {
            console.warn(`Canvas element with id '${canvasId}' not found.`);
            return;
        }
        
        const ctx = ctxElement.getContext('2d');
        const colors = getChartColors();

        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }

        // Safer options merging
        const finalOptions = JSON.parse(JSON.stringify(baseOptions)); // Deep clone base
        
        // Manually merge overrides
        if(optionsOverrides.scales) finalOptions.scales = optionsOverrides.scales;
        if(optionsOverrides.indexAxis) finalOptions.indexAxis = optionsOverrides.indexAxis;
        
        // Merge plugins logic
        if(optionsOverrides.plugins) {
            if(optionsOverrides.plugins.legend) {
                // Ensure base plugins exist if not already present (deep clone handles it usually)
                if(!finalOptions.plugins) finalOptions.plugins = {};
                if(!finalOptions.plugins.legend) finalOptions.plugins.legend = {};
                
                Object.assign(finalOptions.plugins.legend, optionsOverrides.plugins.legend);
            }
        }
        
        // Update text colors for dark mode
        if(finalOptions.plugins && finalOptions.plugins.legend && finalOptions.plugins.legend.labels) {
            finalOptions.plugins.legend.labels.color = colors.text;
        }

        chartInstances[canvasId] = new Chart(ctx, {
            type: type,
            data: data,
            options: finalOptions
        });
    }

    // Event Listeners
    const refreshBtn = document.getElementById('refreshData');
    if(refreshBtn) refreshBtn.addEventListener('click', fetchData);
    
    const timeRangeSelect = document.getElementById('timeRange');
    if(timeRangeSelect) timeRangeSelect.addEventListener('change', fetchData);
    
    const freqSelect = document.getElementById('frequency');
    if(freqSelect) freqSelect.addEventListener('change', fetchData);

    // Initial animations
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        container.style.opacity = '0';
        container.style.transform = 'translateY(20px)';
        setTimeout(() => {
            container.style.transition = 'all 0.6s ease-out';
            container.style.opacity = '1';
            container.style.transform = 'translateY(0)';
        }, 300);
    });
    
    // Header gradient animation
    const header = document.querySelector('.bg-gradient-to-r.from-blue-600');
    if (header) {
        header.style.opacity = '0';
        header.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            header.style.transition = 'all 0.8s ease-out';
            header.style.opacity = '1';
            header.style.transform = 'translateY(0)';
        }, 100);
    }

    // --- Export Functionality ---
    const exportMenuBtn = document.getElementById('exportMenuBtn');
    const exportMenu = document.getElementById('exportMenu');
    
    if (exportMenuBtn && exportMenu) {
        exportMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportMenu.classList.toggle('hidden');
            exportMenu.classList.toggle('opacity-0');
            exportMenu.classList.toggle('scale-95');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!exportMenuBtn.contains(e.target) && !exportMenu.contains(e.target)) {
                exportMenu.classList.add('hidden');
                exportMenu.classList.add('opacity-0');
                exportMenu.classList.add('scale-95');
            }
        });
    }

    // PDF Export
    document.getElementById('exportPDF').addEventListener('click', async () => {
        const { jsPDF } = window.jspdf;
        const btn = document.getElementById('exportPDF');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> {% trans "Generating..." %}';
        
        try {
            // Capture the entire dashboard or specific sections
            // We'll target the main container for charts
            const chartsContainer = document.querySelector('.container.max-w-7xl'); // Adjust selector as needed
            
            if (!chartsContainer) throw new Error("Dashboard container not found");

            const canvas = await html2canvas(chartsContainer, {
                scale: 2, // Improve quality
                useCORS: true,
                logging: false,
                backgroundColor: isDarkMode() ? '#1f2937' : '#ffffff' // Respect theme
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            const imgWidth = pdfWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 0;

            // First page
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;

            // Additional pages
            while (heightLeft > 0) {
                position = position - pdfHeight; // Move image up
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            pdf.save('dashboard-analytics.pdf');
            
        } catch (error) {
            console.error("PDF Generation Error:", error);
            alert("{% trans 'Failed to generate PDF. Please try again.' %}");
        } finally {
            btn.innerHTML = originalText;
            exportMenu.classList.add('hidden');
        }
    });

    // CSV Export
    document.getElementById('exportCSV').addEventListener('click', () => {
        if (!currentDashboardData) {
            alert("{% trans 'No data available to export.' %}");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Helper to add sections
        const addSection = (title, headers, rows) => {
            csvContent += `\n${title}\n`;
            csvContent += headers.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.join(",") + "\n";
            });
        };

        // 1. User Growth
        if (currentDashboardData.user_growth) {
            const rows = currentDashboardData.user_growth.labels.map((label, index) => [label, currentDashboardData.user_growth.data[index]]);
            addSection("User Growth", ["Date", "New Users"], rows);
        }

        // 2. Content Activity
        if (currentDashboardData.content_activity) {
            const d = currentDashboardData.content_activity;
            const rows = d.labels.map((label, index) => [
                label, 
                d.datasets.projects[index],
                d.datasets.news[index],
                d.datasets.stories[index]
            ]);
            addSection("Content Activity", ["Date", "Projects", "News/Events", "Stories"], rows);
        }

        // 3. Projects by Theme
        if (currentDashboardData.themes) {
            const rows = currentDashboardData.themes.labels.map((label, index) => [label, currentDashboardData.themes.data[index]]);
            addSection("Projects by Theme", ["Theme", "Count"], rows);
        }

        // 4. Projects by Country
        if (currentDashboardData.countries) {
            const rows = currentDashboardData.countries.labels.map((label, index) => [label, currentDashboardData.countries.data[index]]);
            addSection("Projects by Country", ["Country", "Count"], rows);
        }
        
        // 5. Demographics (Gender)
        if (currentDashboardData.demographics && currentDashboardData.demographics.gender) {
            const d = currentDashboardData.demographics.gender;
            const rows = d.labels.map((label, index) => [label, d.data[index]]);
            addSection("User Gender", ["Gender", "Count"], rows);
        }

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "dashboard_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        exportMenu.classList.add('hidden');
    });
});
</script>
{% endblock %}
